<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>FlowCode Spectral Flow Unmixing Workflow • FlowCodeUnmix</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="FlowCode Spectral Flow Unmixing Workflow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">FlowCodeUnmix</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/FlowCode_Unmixing_Workflow.html">FlowCode Spectral Flow Unmixing Workflow</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DrCytometer/FlowCodeUnmix/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>FlowCode Spectral Flow Unmixing Workflow</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DrCytometer/FlowCodeUnmix/blob/HEAD/vignettes/articles/FlowCode_Unmixing_Workflow.Rmd" class="external-link"><code>vignettes/articles/FlowCode_Unmixing_Workflow.Rmd</code></a></small>
      <div class="d-none name"><code>FlowCode_Unmixing_Workflow.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You will both need <code>AutoSpectral</code> and
<code>FlowCodeUnmix</code> to run this. If this is your first time using
these, run the installation code below, which should take care of
everything for you.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install Bioconductor packages</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"BiocManager"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://bioconductor.github.io/BiocManager/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"flowWorkspace"</span>, <span class="st">"flowCore"</span>, <span class="st">"PeacoQC"</span>, <span class="st">"FlowSOM"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Install any missing CRAN packages that we'll need</span></span>
<span><span class="va">cran.packages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"shiny"</span>,</span>
<span>  <span class="st">"shinyFiles"</span>,</span>
<span>  <span class="st">"ggplot2"</span>,</span>
<span>  <span class="st">"scattermore"</span>,</span>
<span>  <span class="st">"dplyr"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">missing.pkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span></span>
<span>  <span class="va">cran.packages</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html" class="external-link">installed.packages</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">missing.pkgs</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="va">missing.pkgs</span>, dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># install `remotes` to allow you to install GitHub packages (devtools also works)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"DrCytometer/AutoSpectral"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"DrCytometer/FlowCodeUnmix"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="basic-autospectral-workflow">Basic AutoSpectral workflow<a class="anchor" aria-label="anchor" href="#basic-autospectral-workflow"></a>
</h2>
<p>We start as we would with any spectral flow cytometry data set in
AutoSpectral. We will load the cytometer-specific parameters, load in
the single-stained control FCS data, clean-up the control data, extract
the spectral profiles of the fluorophores, identify autofluorescence
signatures and measure the spectral variation in the fluorophore
output.</p>
<div class="section level3">
<h3 id="load-the-parameters">Load the parameters<a class="anchor" aria-label="anchor" href="#load-the-parameters"></a>
</h3>
<p>Here we are using data from the Cytek Aurora (5-laser system). For
data from a different spectral cytometer, call the appropriate cytometer
as “cytometer”. For more details on the AutoSpectral workflow, see <a href="https://drcytometer.github.io/AutoSpectral/" class="external-link">AutoSpectral
help</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DrCytometer/AutoSpectral" class="external-link">AutoSpectral</a></span><span class="op">)</span></span>
<span><span class="va">autospectral.parameters</span> <span class="op">&lt;-</span> <span class="fu">AutoSpectral</span><span class="fu">::</span><span class="fu"><a href="https://drcytometer.github.io/AutoSpectral/reference/get.autospectral.param.html" class="external-link">get.autospectral.param</a></span><span class="op">(</span></span>
<span>  cytometer <span class="op">=</span> <span class="st">"aurora"</span>,</span>
<span>  figure <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-and-check-the-control-file">Create and check the control file<a class="anchor" aria-label="anchor" href="#create-and-check-the-control-file"></a>
</h3>
<p>The control file is a CSV file (spreadsheet) that describes your
control files for AutoSpectral. A draft of this will be created
automatically by AutoSpectral if you tell it where your single-stained
control files are. You will need to edit this and check it to be sure it
is correct. Details on how to do this are in this <a href="https://drcytometer.github.io/AutoSpectral/articles/02_Control_File_example.html" class="external-link">article</a>.
There is also a <a href="https://github.com/DrCytometer/AutoSpectralHelper" class="external-link">Shiny
helper</a> application for this, which opens as an interactive
webpage.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># where are your single-stained control files?</span></span>
<span><span class="co"># replace the "my_control_folder" with the path to your files.</span></span>
<span><span class="co"># Tip: if you start RStudio by double-clicking on this or another R document,</span></span>
<span><span class="co"># that tells RStudio where you want to work. If you place a folder (say, called SSC)</span></span>
<span><span class="co"># containing your control fcs files in that folder, you will be able to access </span></span>
<span><span class="co"># it with just "./SSC</span></span>
<span><span class="va">control.folder</span> <span class="op">&lt;-</span> <span class="st">"C://User/Documents/my_control_folder"</span></span>
<span></span>
<span><span class="co"># or</span></span>
<span><span class="va">control.folder</span> <span class="op">&lt;-</span> <span class="st">"./SSC"</span></span>
<span></span>
<span><span class="fu">AutoSpectral</span><span class="fu">::</span><span class="fu"><a href="https://drcytometer.github.io/AutoSpectral/reference/create.control.file.html" class="external-link">create.control.file</a></span><span class="op">(</span></span>
<span>  control.dir <span class="op">=</span> <span class="va">control.folder</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Once you have edited your control file, check it:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">control.file</span> <span class="op">&lt;-</span> <span class="st">"fcs_control_file.csv"</span></span>
<span><span class="fu">AutoSpectral</span><span class="fu">::</span><span class="fu"><a href="https://drcytometer.github.io/AutoSpectral/reference/check.control.file.html" class="external-link">check.control.file</a></span><span class="op">(</span></span>
<span>  control.dir <span class="op">=</span> <span class="va">control.folder</span>,</span>
<span>  control.def.file <span class="op">=</span> <span class="va">control.file</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="load-the-data">Load the data<a class="anchor" aria-label="anchor" href="#load-the-data"></a>
</h3>
<p>This step will likely take a few minutes. AutoSpectral will now take
all of the information in the control file, read in all the
single-stained FCS files, determine gates to use and extract the
information in the gates for downstream usage. This can go faster by
setting <code>parallel = TRUE</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu">AutoSpectral</span><span class="fu">::</span><span class="fu"><a href="https://drcytometer.github.io/AutoSpectral/reference/define.flow.control.html" class="external-link">define.flow.control</a></span><span class="op">(</span></span>
<span>  control.dir <span class="op">=</span> <span class="va">control.folder</span>,</span>
<span>  control.def.file <span class="op">=</span> <span class="va">control.file</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Check the plots in folder <code>figure_gate</code> to be sure the
gating is working appropriately for your samples. See the help pages if
it does not look good.</p>
</div>
<div class="section level3">
<h3 id="clean-the-controls">Clean the controls<a class="anchor" aria-label="anchor" href="#clean-the-controls"></a>
</h3>
<p>This will also take a few minutes, most likely. In this step, we are
trying to identify the most useful events in the single-stained controls
for determining the fluorophore spectra. This involves removing any
cells (in cell-based controls) that interfere with the measurement
(e.g., autofluorescent macrophages or dead cells), selecting the
brightest events and matching the background of those events in the
unstained sample.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cleaned.controls</span> <span class="op">&lt;-</span> <span class="fu">AutoSpectral</span><span class="fu">::</span><span class="fu"><a href="https://drcytometer.github.io/AutoSpectral/reference/clean.controls.html" class="external-link">clean.controls</a></span><span class="op">(</span></span>
<span>  flow.control <span class="op">=</span> <span class="va">flow.control</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="measure-the-fluorophore-spectral-profiles">Measure the fluorophore spectral profiles<a class="anchor" aria-label="anchor" href="#measure-the-fluorophore-spectral-profiles"></a>
</h3>
<p>Now we will extract the fluorophore spectral information from the
cleaned data. This should be relatively quick. Plots will appear in
<code>figure_spectra</code> and
<code>figure_similarity_heatmap</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fluorophore.spectra</span> <span class="op">&lt;-</span> <span class="fu">AutoSpectral</span><span class="fu">::</span><span class="fu"><a href="https://drcytometer.github.io/AutoSpectral/reference/get.fluorophore.spectra.html" class="external-link">get.fluorophore.spectra</a></span><span class="op">(</span></span>
<span>  flow.control <span class="op">=</span> <span class="va">cleaned.controls</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span>,</span>
<span>  use.clean.expr <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="measure-autofluorescence-spectra">Measure autofluorescence spectra<a class="anchor" aria-label="anchor" href="#measure-autofluorescence-spectra"></a>
</h3>
<p>Autofluorescence is always present in our stained cells, including
our single-stained cell controls. This is a source of variability that
contributes to noise (spread) in our unmixed data. We need to identify
the variability in autofluorescence to counteract this. With FlowCode
data, we will often have different tissue sources, each of which will
have a distinct distribution of autofluorescence profiles. We will
eventually need to identify all of those. To start, though, we will
identify only the variability in the type of sample we are using for the
single-stained controls. For instance, with mouse studies, these will
likely be splenocytes, so we will use unstained spleen as the source of
our autofluorescence.</p>
<p>In this example, I have an unstained spleen sample as the “Unstained”
(so named by SpectroFlo) in my reference control group. This FCS file is
in the single-stained control folder, along with all of the other
controls.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spleen.autofluorescence</span> <span class="op">&lt;-</span> <span class="fu">AutoSpectral</span><span class="fu">::</span><span class="fu"><a href="https://drcytometer.github.io/AutoSpectral/reference/get.af.spectra.html" class="external-link">get.af.spectra</a></span><span class="op">(</span></span>
<span>  unstained.sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span> <span class="va">control.folder</span>, <span class="st">"Unstained.fcs"</span> <span class="op">)</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span>,</span>
<span>  spectra <span class="op">=</span> <span class="va">fluorophore.spectra</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="determine-spectral-variation-in-the-fluorophores">Determine spectral variation in the fluorophores<a class="anchor" aria-label="anchor" href="#determine-spectral-variation-in-the-fluorophores"></a>
</h3>
<p>Now that we know the contribution of autofluorescence to the
variation, we can extract the variation from the fluorophore emissions
themselves.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fluorophore.variation</span> <span class="op">&lt;-</span> <span class="fu">AutoSpectral</span><span class="fu">::</span><span class="fu"><a href="https://drcytometer.github.io/AutoSpectral/reference/get.spectral.variants.html" class="external-link">get.spectral.variants</a></span><span class="op">(</span></span>
<span>  control.dir <span class="op">=</span> <span class="va">control.folder</span>,</span>
<span>  control.def.file <span class="op">=</span> <span class="va">control.file</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span>,</span>
<span>  spectra <span class="op">=</span> <span class="va">fluorophore.spectra</span>,</span>
<span>  af.spectra <span class="op">=</span> <span class="va">spleen.autofluorescence</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>That is the end of the normal AutoSpectral workflow for us. We now
need to do some FlowCode-specific steps before proceeding to the
debarcoding and unmixing.</p>
</div>
</div>
<div class="section level2">
<h2 id="flowcode-unmixing-workflow">FlowCode Unmixing Workflow<a class="anchor" aria-label="anchor" href="#flowcode-unmixing-workflow"></a>
</h2>
<p>For the FlowCode workflow, we need some additional pieces of
information: * Which are the FlowCode epitope tag channels? * What are
the valid FlowCode combinations (in the combination file)? * What is the
name (guide/TCR) of each combination (in the combination file)? * Where
are the cells (user-drawn gate)? * What variation in fluorophore output
is created by the combinations due to FRET or a FRET-like artifact? For
this, we need your backbone control, stained only with the FlowCode
epitope antibodies. All combinations should be well represented for best
results.</p>
<div class="section level3">
<h3 id="where-is-everything">Where is everything?<a class="anchor" aria-label="anchor" href="#where-is-everything"></a>
</h3>
<p>Provide the location (file path) and name of your backbone FCS file.
Provide the name (and file path) of your combination CSV file.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flowcode.backbone</span> <span class="op">&lt;-</span> <span class="st">"./Raw/FC control (Spleen)/F2 FC_FRET_02_Plate_002.fcs"</span> </span>
<span><span class="va">combo.file</span> <span class="op">&lt;-</span> <span class="st">"OTB01 Treg Tx factor combinations.csv"</span></span></code></pre></div>
<p>Now we can unmix the backbone control, using a slight adaptation of
the AutoSpectral unmixing approach. This is a spleen-based sample, so we
use <code>spleen.autofluorescence</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">FlowCodeUnmix</span><span class="fu">::</span><span class="fu"><a href="../reference/unmix.backbone.html">unmix.backbone</a></span><span class="op">(</span></span>
<span>   flowcode.backbone.fcs <span class="op">=</span> <span class="va">flowcode.backbone</span>,</span>
<span>   spectra <span class="op">=</span> <span class="va">fluorophore.spectra</span>,</span>
<span>   af.spectra <span class="op">=</span> <span class="va">spleen.autofluorescence</span>,</span>
<span>   flow.control <span class="op">=</span> <span class="va">cleaned.controls</span>,</span>
<span>   asp <span class="op">=</span> <span class="va">autospectral.parameters</span>,</span>
<span>   flowcode.combo.file <span class="op">=</span> <span class="va">combo.file</span>,</span>
<span>   output.dir <span class="op">=</span> <span class="st">"./flowcode_spectra"</span>,</span>
<span>   filename <span class="op">=</span> <span class="st">"FlowCode_Backbone.rds"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This saves the output as an RDS file in the folder specified by
<code>output.dir</code>. If you change <code>output.dir</code>, you’ll
need to change it later in <code><a href="../reference/get.flowcode.spectra.html">get.flowcode.spectra()</a></code>. *Note:
change to returning object</p>
</div>
<div class="section level3">
<h3 id="setting-thresholds">Setting thresholds<a class="anchor" aria-label="anchor" href="#setting-thresholds"></a>
</h3>
<p>This part requires you to manually select the point on the graph
where the data start becoming “positive” for each of the FlowCode
epitope tags. That is, where is the threshold for having the FlowCode or
not? This is manual because it’s pretty hard to do it well in an
automated manner considering that at this stage we still have FRET-based
unmixing issues.</p>
<p>I have created a Shiny app to allow you to do this interactively, as
in Orian Bricard’s FlowCode debarcoding app.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">FlowCodeUnmix</span><span class="fu">::</span><span class="fu"><a href="../reference/launch.threshold.app.html">launch.threshold.app</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>When you’re done, you should have a CSV file (spreadsheet), which is
pretty simple and just contains the numerical value corresponding to the
threshold for each FlowCode channel.</p>
</div>
<div class="section level3">
<h3 id="measuring-fret-unmixing-errors-due-to-flowcodes">Measuring FRET (unmixing) errors due to FlowCodes<a class="anchor" aria-label="anchor" href="#measuring-fret-unmixing-errors-due-to-flowcodes"></a>
</h3>
<p>In this step, we will take the FlowCode epitope-stained backbone data
(from the unmixed data in the RDS file), debarcode it to identify valid
combinations, and assess spectral unmixing errors per combination. This
gives us a set of potential corrections to apply to each cell for a
given barcode combination.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flowcode.spectra</span> <span class="op">&lt;-</span> <span class="fu">FlowCodeUnmix</span><span class="fu">::</span><span class="fu"><a href="../reference/get.flowcode.spectra.html">get.flowcode.spectra</a></span><span class="op">(</span></span>
<span>  backbone.rds <span class="op">=</span> <span class="st">"./flowcode_spectra/FlowCode_Backbone.rds"</span>,</span>
<span>  thresholds.file <span class="op">=</span> <span class="st">"./flowcode_spectra/thresholds.csv"</span>,</span>
<span>  output.dir <span class="op">=</span> <span class="st">"./flowcode_spectra"</span>,</span>
<span>  filename <span class="op">=</span> <span class="st">"FlowCode_Spectra.rds"</span>,</span>
<span>  plot.corrections <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This call saves the output as an RDS file in the folder specified by
<code>output.dir</code>. If you select
<code>plot.corrections = TRUE</code>, it will identify the FRET errors
on a cell-by-cell basis, correct them, and plot examples of what the
FlowCode epitope unmixing looks like on the backbone file with and
without corrections. That can be a bit slow, but is definitely worth
doing the first couple of times.</p>
</div>
<div class="section level3">
<h3 id="flowcode-unmixing">FlowCode Unmixing<a class="anchor" aria-label="anchor" href="#flowcode-unmixing"></a>
</h3>
<p>We now have all the data required for unmixing, or, at least we do
for the any files coming from spleen. We’ll get to other tissue sources
in a second.</p>
<p>To unmix a single file, call <code><a href="../reference/unmix.flowcode.fcs.html">unmix.flowcode.fcs()</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for example:</span></span>
<span><span class="va">fully.stained.spleen</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Spleen/Spleen_Mouse_001.fcs"</span></span>
<span></span>
<span><span class="co"># then call:</span></span>
<span><span class="fu">FlowCodeUnmix</span><span class="fu">::</span><span class="fu"><a href="../reference/unmix.flowcode.fcs.html">unmix.flowcode.fcs</a></span><span class="op">(</span></span>
<span>  fcs.file <span class="op">=</span> <span class="va">fully.stained.spleen</span>,</span>
<span>  spectra <span class="op">=</span> <span class="va">fluorophore.spectra</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span>,</span>
<span>  flow.control <span class="op">=</span> <span class="va">cleaned.controls</span>,</span>
<span>  af.spectra <span class="op">=</span> <span class="va">spleen.autofluorescence</span>,</span>
<span>  spectra.variants <span class="op">=</span> <span class="va">fluorophore.variation</span>,</span>
<span>  flowcode.spectra <span class="op">=</span> <span class="va">flowcode.spectra</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">10</span>, <span class="co"># use k = 1 for fastest unmixing, k = 10 (default) for slower but better, k ~ 3 compromise</span></span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>To unmix a folder containing many files, call
<code>unmix.flowcode.folder()</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for example:</span></span>
<span><span class="va">spleen.folder</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Spleen/"</span></span>
<span></span>
<span><span class="co"># then call:</span></span>
<span><span class="fu">FlowCodeUnmix</span><span class="fu">::</span><span class="fu">unmix.flowcode.folder</span><span class="op">(</span></span>
<span>  sample.dir <span class="op">=</span> <span class="va">spleen.folder</span>,</span>
<span>  spectra <span class="op">=</span> <span class="va">fluorophore.spectra</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span>,</span>
<span>  flow.control <span class="op">=</span> <span class="va">cleaned.controls</span>,</span>
<span>  af.spectra <span class="op">=</span> <span class="va">spleen.autofluorescence</span>,</span>
<span>  spectra.variants <span class="op">=</span> <span class="va">fluorophore.variation</span>,</span>
<span>  flowcode.spectra <span class="op">=</span> <span class="st">"./flowcode_spectra/FlowCode_Spectra.rds"</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If we want to look at other tissues sources, or any samples where the
autofluorescence may differ from the autofluorescence profiles we have
already extracted, we first need to call
<code><a href="https://drcytometer.github.io/AutoSpectral/reference/get.af.spectra.html" class="external-link">AutoSpectral::get.af.spectra()</a></code> on unstained samples
representing those autofluorescence sources. We can then unmix samples
from those tissues, extracting the matching autofluorescence
correctly.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Let's say we have brain samples</span></span>
<span></span>
<span><span class="co"># this is our unstained brain sample (raw data)</span></span>
<span><span class="va">unstained.brain</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Unstained controls/Unstained brain.fcs"</span></span>
<span></span>
<span><span class="co"># we extract the AF profiles from it</span></span>
<span><span class="va">brain.autofluorescence</span> <span class="op">&lt;-</span> <span class="fu">AutoSpectral</span><span class="fu">::</span><span class="fu"><a href="https://drcytometer.github.io/AutoSpectral/reference/get.af.spectra.html" class="external-link">get.af.spectra</a></span><span class="op">(</span></span>
<span>  unstained.sample <span class="op">=</span> <span class="va">unstained.brain</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span>,</span>
<span>  spectra <span class="op">=</span> <span class="va">fluorophore.spectra</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now we want the raw data for the fully stained brain sample</span></span>
<span><span class="va">fully.stained.brain</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Brain/Brain_Mouse_001.fcs"</span></span>
<span></span>
<span><span class="co"># then call to unmix:</span></span>
<span><span class="fu">FlowCodeUnmix</span><span class="fu">::</span><span class="fu"><a href="../reference/unmix.flowcode.fcs.html">unmix.flowcode.fcs</a></span><span class="op">(</span></span>
<span>  fcs.file <span class="op">=</span> <span class="va">fully.stained.brain</span>, <span class="co"># change the sample</span></span>
<span>  spectra <span class="op">=</span> <span class="va">fluorophore.spectra</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span>,</span>
<span>  flow.control <span class="op">=</span> <span class="va">cleaned.controls</span>,</span>
<span>  af.spectra <span class="op">=</span> <span class="va">brain.autofluorescence</span>, <span class="co"># change the autofluorescence to match</span></span>
<span>  spectra.variants <span class="op">=</span> <span class="va">fluorophore.variation</span>,</span>
<span>  flowcode.spectra <span class="op">=</span> <span class="st">"./flowcode_spectra/FlowCode_Spectra.rds"</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In many cases, the thresholds for positivity may vary slightly by
tissue type or sample source. If that is the case, you will need to
provide new thresholds as part of the unmixing process. To start, unmix
a single FCS file from the source you want to use to set new thresholds.
Do the unmixing with AutoSpectral, extracting the AF per cell, since
this will get you closer to what the data will look like with the
FlowCodeUnmix. Then load this file into the ThresholdApp, select new
thresholds for each FlowCode marker, and save the results (you can and
should rename the CSV file). Now provide this new CSV file containing
the updated thresholds to the unmixing.</p>
<p>I suspect that in most cases there will be little need for
re-thresholding between different tissues. There may be a need to
re-threshold on a fully stained sample, though, since this will differ
from the backbone control we have used to establish the first set of
thresholds.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># this is our unstained brain sample (raw data)</span></span>
<span><span class="va">unstained.brain</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Unstained controls/Unstained brain.fcs"</span></span>
<span></span>
<span><span class="co"># we extract the AF profiles from it</span></span>
<span><span class="va">brain.autofluorescence</span> <span class="op">&lt;-</span> <span class="fu">AutoSpectral</span><span class="fu">::</span><span class="fu"><a href="https://drcytometer.github.io/AutoSpectral/reference/get.af.spectra.html" class="external-link">get.af.spectra</a></span><span class="op">(</span></span>
<span>  unstained.sample <span class="op">=</span> <span class="va">unstained.brain</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span>,</span>
<span>  spectra <span class="op">=</span> <span class="va">fluorophore.spectra</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now we want the raw data for the fully stained brain sample</span></span>
<span><span class="va">fully.stained.brain</span> <span class="op">&lt;-</span> <span class="st">"./Raw/Brain/Brain_Mouse_001.fcs"</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/launch.threshold.app.html">launch.threshold.app</a></span><span class="op">(</span></span>
<span>  flowcode.combo.file <span class="op">=</span> <span class="va">combo.file</span>,</span>
<span>  flow.control <span class="op">=</span> <span class="va">cleaned.controls</span>,</span>
<span>  spectra <span class="op">=</span> <span class="va">fluorophore.spectra</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">new.thresholds</span> <span class="op">&lt;-</span> <span class="st">"./flowcode_spectra/New_thresholds.csv"</span></span>
<span></span>
<span><span class="co"># then call to unmix:</span></span>
<span><span class="fu">FlowCodeUnmix</span><span class="fu">::</span><span class="fu"><a href="../reference/unmix.flowcode.fcs.html">unmix.flowcode.fcs</a></span><span class="op">(</span></span>
<span>  fcs.file <span class="op">=</span> <span class="va">fully.stained.brain</span>, <span class="co"># change the sample</span></span>
<span>  spectra <span class="op">=</span> <span class="va">fluorophore.spectra</span>,</span>
<span>  asp <span class="op">=</span> <span class="va">autospectral.parameters</span>,</span>
<span>  flow.control <span class="op">=</span> <span class="va">cleaned.controls</span>,</span>
<span>  af.spectra <span class="op">=</span> <span class="va">brain.autofluorescence</span>, <span class="co"># change the autofluorescence to match</span></span>
<span>  spectra.variants <span class="op">=</span> <span class="va">fluorophore.variation</span>,</span>
<span>  flowcode.spectra <span class="op">=</span> <span class="st">"./flowcode_spectra/FlowCode_Spectra.rds"</span>,</span>
<span>  thresholds.file <span class="op">=</span> <span class="va">new.thresholds</span>, <span class="co"># specify new thresholds</span></span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="flowcode-debarcoding-workflow">FlowCode Debarcoding Workflow<a class="anchor" aria-label="anchor" href="#flowcode-debarcoding-workflow"></a>
</h2>
<p>With the new unmixing, the resulting FCS files are already
debarcoded. If you inspect the files in R or FlowJo, you should see a
channel for each of the tags (names, guides, TCRs) you have linked to
each FlowCode combination. The expression in these channels is the
expression of that combination of FlowCode epitopes in the cells.
Additionally, you should have a “FlowCode” channel, which is the
expression level of the epiopes in cells with valid FlowCode
combinations. In other words, the “FlowCode” channel measures
transduction.</p>
<p>So, in FlowJo, you can gate on your cells and then plot a tag combo
versus whatever markers you have in your flow panel. This is useful for
checking CRISPR guide efficiency (for example, plotting GATA-3
expression in Gata3-targeted cells) or for phenotyping. If you want, you
can run dimensionality reduction and clustering approaches in FlowJo, R
or Python on the FCS files as they are or with some pre-gating.</p>
<p>For our analyses, we recommend pre-gating to specific biologically
relevant cell populations. I still need to write the part to do this in
R. At present, you should be able to treat the unmixed FCS files you get
from this workflow as you would previously, running them through Orian
Bricard’s <a href="https://github.com/DrCytometer/FlowcodeDecoder" class="external-link">FlowCodeDecoder</a>.
The difference is that the unmixing will now be correct (hopefully),
both for the barcodes and for the phenotyping and gating markers.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Oliver Burton.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
